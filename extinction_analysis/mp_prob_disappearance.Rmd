---
title: "Moving Pictures Probability of Extinction"
author: "Daniel J. Park"
date: "7/17/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(ggplot2)
library(dplyr)
library(boot)
require(foreign)
require(MASS)
require(Hmisc)
library(segmented)
library(drc)
library(nlme)
source("../mp_analysis_functions.R")
```

```{r}
# subjID: f4, m3
# <subjID>.metadata : metadata sorted by time
# otu.counts.<subjID> : OTU counts
# otu.relabs.<subjID> : OTU relative abundances
# otu.clrabs.<subjID> : OTU clr-transformed abundances
# median.otu.relabs.<subjID> : OTU's median relative abundance across all samples
# median.otu.clrabs.<subjID> : OTU's median clr-transformed abundance across all samples
# coverage.<subjID> : the total number of reads by sample
load("../mp_F4_data.Rdata")
load("../mp_M3_data.Rdata")
```

# Probability of extinction
Given that a taxa is present at time $t-1$, what is the probability that the taxa disappears at time $t$?

```{r}
# probability of extinction by taxa for subjects F4 and M3
f4.disappearance.probs <- disappearance_probabilities(otu.counts.f4)
m3.disappearance.probs <- disappearance_probabilities(otu.counts.m3)

# prob.disappear: probability of extinction
# log.median.relabs: the log of a taxon's median relative abundance across all samples
# median.clr: a taxon's median clr-transformed abundance across all samples
f4.otu.disappearance <- data.frame(prob.disappear = f4.disappearance.probs, 
                                   log.median.relabs = log(median.otu.relabs.f4),
                                   median.clr = median.otu.clrabs.f4)
m3.otu.disappearance <- data.frame(prob.disappear = m3.disappearance.probs,
                                   log.median.relabs = log(median.otu.relabs.m3),
                                   median.clr = median.otu.clrabs.m3)

p.f4 <- ggplot(f4.otu.disappearance, aes(x = log.median.relabs, y = prob.disappear)) +
  geom_point(color="purple") +
  labs(ylab = "probability of extinction", xlab = "log(median relative abundance)", title = "Subject F4: Probability of Extinction by OTU")
p.m3 <- ggplot(m3.otu.disappearance, aes(x = log.median.relabs, y = prob.disappear)) +
  geom_point(color="maroon") +
  labs(ylab = "probability of extinction", xlab = "log(median relative abundance)", title = "Subject M3: Probability of Extinction by OTU")

q.f4 <- ggplot(f4.otu.disappearance, aes(x = median.clr, y = prob.disappear)) +
  geom_point(color="orchid") + 
  labs(ylab = "probability of extinction", xlab = "median clr-transformed abundance", title = "Subject F4: Probability of Extinction by OTU")
q.m3 <- ggplot(m3.otu.disappearance, aes(x = median.clr, y = prob.disappear)) +
  geom_point(color="tomato") + 
  labs(ylab = "probability of extinction", xlab = "median clr-transformed abundance", title = "Subject M3: Probability of Extinction by OTU")

ggsave("f4_otu_prob_extinction.png", q.f4)
ggsave("m3_otu_prob_extinction.png", q.m3)
```

# Piecewise linear regression 

```{r}
segmented.lm.f4 <- segmented(lm(prob.disappear ~ median.clr, data = f4.otu.disappearance))
segmented.lm.m3 <- segmented(lm(prob.disappear ~ median.clr, data = m3.otu.disappearance))

f4.otu.disappearance$piecewise.fitted <- segmented.lm.f4$fitted.values
m3.otu.disappearance$piecewise.fitted <- segmented.lm.m3$fitted.values

# plot observed and fitted probability of OTU extinction
piecewise.q.f4 <- q.f4 + 
  geom_line(data = f4.otu.disappearance, aes(x = median.clr, y = piecewise.fitted), color="blue", size=1) +
  geom_vline(xintercept = segmented.lm.f4$psi[ ,2], linetype = "dashed")
piecewise.q.m3 <- q.m3 +
  geom_line(data = m3.otu.disappearance, aes(x = median.clr, y = piecewise.fitted), color="blue", size=1) +
  geom_vline(xintercept = segmented.lm.m3$psi[ ,2], linetype = "dashed")
  
piecewise.q.f4
piecewise.q.m3
```

## Set bound of linear regression fitted values at 0

```{r}
f4.otu.disappearance$piecewise.fitted[f4.otu.disappearance$piecewise.fitted < 0] <- 0
m3.otu.disappearance$piecewise.fitted[m3.otu.disappearance$piecewise.fitted < 0] <- 0

q.f4 + 
  geom_line(data = f4.otu.disappearance, aes(x = median.clr, y = piecewise.fitted), color="blue", size=1)

q.m3 +
  geom_line(data = m3.otu.disappearance, aes(x = median.clr, y = piecewise.fitted), color="blue", size=1)
```

# Asymptotic regression 

```{r}
asymp.reg.f4 <- nls(prob.disappear ~ SSasympOff(median.clr, Asym, lrc, c0), data = f4.otu.disappearance)
asymp.reg.m3 <- nls(prob.disappear ~ SSasympOff(median.clr, Asym, lrc, c0), data = m3.otu.disappearance)

f4.otu.disappearance$asymp.fitted <- predict(asymp.reg.f4)
m3.otu.disappearance$asymp.fitted <- predict(asymp.reg.m3)

# if any fitted asymptotic regression values are less than 0, set to 0
f4.otu.disappearance$asymp.fitted[f4.otu.disappearance$asymp.fitted < 0] <- 0
m3.otu.disappearance$asymp.fitted[m3.otu.disappearance$asymp.fitted < 0] <- 0

q.f4 + 
  geom_line(data = f4.otu.disappearance, aes(x = median.clr, y = asymp.fitted), color="blue", size=1)

q.m3 + 
  geom_line(data = m3.otu.disappearance, aes(x = median.clr, y = asymp.fitted), color="blue", size=1)
```

# Zero-inflated Asymptotic Regression
Split the data into two parts: zero probabilities and non-zero probabilities. Model Pr($\pi_k$=0) with a logistic function regressing on taxa $k$'s median clr-transformed abundance, where $\pi_k$ is the probability that taxa $k$ goes extinct at time $t$. 

## Zero-inflation Logistic Regression 

```{r}
f4.otu.disappearance$pi.is.zero <- ifelse(f4.otu.disappearance$prob.disappear == 0, 1, 0)
m3.otu.disappearance$pi.is.zero <- ifelse(m3.otu.disappearance$prob.disappear == 0, 1, 0)

zero.logistic.f4 <- glm(pi.is.zero ~ median.clr, 
                        data = f4.otu.disappearance, family = "binomial")
zero.logistic.m3 <- glm(pi.is.zero ~ median.clr, 
                        data = m3.otu.disappearance, family = "binomial")

ggplot(f4.otu.disappearance, aes(x=median.clr, y=pi.is.zero)) +
  geom_point() +
  geom_smooth(method = "glm", method.args = list(family = "binomial")) +
  labs(title = "Subject F4: Zero-Inflation Logistic Regression")

ggplot(m3.otu.disappearance, aes(x=median.clr, y=pi.is.zero)) +
  geom_point() +
  geom_smooth(method = "glm", method.args = list(family = "binomial")) +
  labs(title = "Subject M3: Zero-Inflation Logistic Regression")
```

## Asymptotic Regression on Non-zero Probabilities

```{r}
nonzero.probs.f4 <- subset(f4.otu.disappearance, pi.is.zero == 0)
nonzero.probs.m3 <- subset(m3.otu.disappearance, pi.is.zero == 0)

nls.coefs.f4 <- NLSstAsymptotic(sortedXyData(x = nonzero.probs.f4$median.clr, 
                                             y = nonzero.probs.f4$prob.disappear))
nls.coefs.m3 <- NLSstAsymptotic(sortedXyData(x = nonzero.probs.m3$median.clr, 
                                             y = nonzero.probs.m3$prob.disappear))

f4.otu.disappearance$zi.asymp.fitted <- predict_AsympReg(f4.otu.disappearance$median.clr, nls.coefs.f4)
m3.otu.disappearance$zi.asymp.fitted <- predict_AsympReg(m3.otu.disappearance$median.clr, nls.coefs.m3)

# if any fitted asymptotic regression values are less than 0, set to 0
f4.otu.disappearance$zi.asymp.fitted[f4.otu.disappearance$zi.asymp.fitted < 0] <- 0
m3.otu.disappearance$zi.asymp.fitted[m3.otu.disappearance$zi.asymp.fitted < 0] <- 0

q.f4 +
  geom_line(data = f4.otu.disappearance, aes(x = median.clr, y = zi.asymp.fitted), color="blue", size=1)

q.m3 + 
  geom_line(data = m3.otu.disappearance, aes(x = median.clr, y = zi.asymp.fitted), color="blue", size=1)
```

# Model Comparison
How do the performances of piecewise linear regression and zero-inflated asymptotic regression compare?

## Subject F4

```{r}
set.seed(0)

n.f4 <- nrow(f4.otu.disappearance)
# these are the indices for OTUs predicted to be zeros
zero.inflated.f4 <- rbinom(n = n.f4, size = 1, prob = zero.logistic.f4$fitted.values)

# zero-inflated asymptotic regression predicted probabilities
# if zero.inflated == 1: ziar.predicted := 0
# else: ziar.predicted := zi.asymp.fitted
f4.otu.disappearance$ziar.predicted <- f4.otu.disappearance$zi.asymp.fitted
f4.otu.disappearance$ziar.predicted[zero.inflated.f4 == 1] <- 0

models <- c("ziar.predicted", "zi.asymp.fitted", "asymp.fitted", "piecewise.fitted")

for (model in models) {
  correlation <- cor(f4.otu.disappearance$prob.disappear, f4.otu.disappearance[ , model])
  print(paste("Pearson correlation between observed and", model, ":", correlation))
}

for (model in models) {
  mse <- mean((f4.otu.disappearance$prob.disappear - f4.otu.disappearance[ , model])^2)
  print(paste("MSE between of", model, ":", mse))
}
```


## Subject M3
```{r}
set.seed(0)

n.m3 <- nrow(m3.otu.disappearance)
# these are the indices for OTUs predicted to be zeros
zero.inflated.m3 <- rbinom(n = n.m3, size = 1, prob = zero.logistic.m3$fitted.values)

# zero-inflated asymptotic regression predicted probabilities
# if zero.inflated == 1: ziar.predicted := 0
# else: ziar.predicted := zi.asymp.fitted
m3.otu.disappearance$ziar.predicted <- m3.otu.disappearance$zi.asymp.fitted
m3.otu.disappearance$ziar.predicted[zero.inflated.m3 == 1] <- 0

for (model in models) {
  correlation <- cor(m3.otu.disappearance$prob.disappear, m3.otu.disappearance[ , model])
  print(paste("Pearson correlation between observed and", model, ":", correlation))
}

for (model in models) {
  mse <- mean((m3.otu.disappearance$prob.disappear - m3.otu.disappearance[ , model])^2)
  print(paste("MSE between of", model, ":", mse))
}
```





