---
title: "Dethlefsen and Relman Microbiome Dataset"
author: "Daniel J. Park"
date: "10/25/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dplyr)
library(data.table)
library(phyloseq)
library(microbiome)
```

# Only Qualitative Difference Scenarios

```{r}
d <- seq(from = 0, to = 1, by = 0.1)
power.table <- matrix(nrow = length(d), ncol = 10)
colnames(power.table) <- c("delta", "disapp", "reapp", "quant", 
                           "bray_qual", "bray_quant", "bray_omni", 
                           "adhoc_bray_qual", "adhoc_bray_quant", "quant_meanL2")

alpha <- 0.05
for (i in 1:length(d)) {
  disapp.tests <- as.matrix(read.table(paste("testresults/qual_disapp_d", d[i], "_s1.txt", sep = ""), header = TRUE, colClasses = c("numeric")))
  reapp.tests <- as.matrix(read.table(paste("testresults/qual_reapp_d", d[i], "_s1.txt", sep = ""), header = TRUE, colClasses = c("numeric")))
  quant.tests <- as.matrix(read.table(paste("testresults/quant_d", d[i], "_s1.txt", sep = ""), header = TRUE, colClasses = c("numeric")))
  pldist.tests <- as.matrix(read.table(paste("testresults/pldist_bray_d", d[i], "_s1.txt", sep = ""), header = TRUE, colClasses = c("numeric")))
  adhoc.qual <- as.matrix(read.table(paste("testresults/adhoc_bray_qual_d", d[i], "_s1.txt", sep = ""), header = TRUE, colClasses = c("numeric")))
  adhoc.quant <- as.matrix(read.table(paste("testresults/adhoc_bray_quant_d", d[i], "_s1.txt", sep = ""), header = TRUE, colClasses = c("numeric")))
  quant.meanL2 <- as.matrix(read.table(paste("testresults/quant_d", d[i], "_s1_int1_meanL2.txt", sep = ""), header = TRUE, colClasses = c("numeric")))

  disapp.pvals <- disapp.tests[ , ncol(disapp.tests)]
  reapp.pvals <- reapp.tests[ ,ncol(reapp.tests)]
  quant.pvals <- quant.tests[ ,ncol(quant.tests)]
  adhoc.qual.pvals <- adhoc.qual[ ,ncol(adhoc.qual)]
  adhoc.quant.pvals <- adhoc.quant[ ,ncol(adhoc.quant)]
  quant.meanL2.pvals <- quant.meanL2[ ,ncol(quant.meanL2)]
  
  power.table[i,1] <- d[i] # difference in mean of subject random intercept distribution between groups
  power.table[i,2] <- mean(disapp.pvals < alpha, na.rm = TRUE) # power
  power.table[i,3] <- mean(reapp.pvals < alpha, na.rm = TRUE)
  power.table[i,4] <- mean(quant.pvals < alpha, na.rm = TRUE)
  power.table[i,5:7] <- apply(pldist.tests, 2, function(x) mean(x < alpha, na.rm = TRUE))
  power.table[i,8] <- mean(adhoc.qual.pvals < alpha, na.rm = TRUE)
  power.table[i,9] <- mean(adhoc.quant.pvals < alpha, na.rm = TRUE)
  power.table[i,10] <- mean(quant.meanL2.pvals < alpha, na.rm = TRUE)

  # print(paste("For delta = ", d[i], ", ", length(pvals), " tests were returned.", sep = ""))
  # hist(pvals, breaks = seq(from = 0, to = 1, by = 0.05), xlim = c(0,1), 
  #      main = bquote("Histogram of p-values for " ~ delta == .(d[i])))
}
```

```{r}
plot(x = power.table[ ,1], y = power.table[ ,2], ylim = c(0,1), type = "o", pch = 15, lty = 1, col = "red",
     main = "Qualitative Difference Only Scenarios", xlab = expression("Effect Size" ~ delta), ylab = "Power")

points(x = power.table[ ,1], y = power.table[ ,3], pch = 16, col = "red")
lines(x = power.table[ ,1], y = power.table[ ,3], lty = 2, col = "red")
points(x = power.table[ ,1], y = power.table[ ,4], pch = 17, col = "red")
lines(x = power.table[ ,1], y = power.table[ ,4], lty = 3, col = "red")
points(x = power.table[ ,1], y = power.table[ ,5], pch = 1)
lines(x = power.table[ ,1], y = power.table[ ,5], lty = 4)
points(x = power.table[ ,1], y = power.table[ ,6], pch = 2)
lines(x = power.table[ ,1], y = power.table[ ,6], lty = 5)
points(x = power.table[ ,1], y = power.table[ ,7], pch = 5)
lines(x = power.table[ ,1], y = power.table[ ,7], lty = 6)
points(x = power.table[ ,1], y = power.table[ ,8], pch = 3)
lines(x = power.table[ ,1], y = power.table[ ,8], lty = 7)
points(x = power.table[ ,1], y = power.table[ ,9], pch = 4)
lines(x = power.table[ ,1], y = power.table[ ,9], lty = 8)
points(x = power.table[ ,1], y = power.table[ ,10], pch = 18, col = "red")
lines(x = power.table[ ,1], y = power.table[ ,10], lty = 9, col = "red")

legend(0, 1, legend=c("Disapp", "Reapp","Quant", 
                      expression(K[BB]), expression(K[BQ]), expression(K[omni]),
                      expression(adhoc[BB]), expression(adhoc[BQ]), bquote("Quant"["Mean L2"])),
       pch=c(15, 16, 17, 1, 2, 5, 3, 4, 18), lty=1:(ncol(power.table)-1), 
       col=c(rep("red", 3), rep("black", (ncol(power.table)-5)), "red"), 
       ncol=1)

power.table
```

## Balanced Subsampled: 4 Intervals of 30 Time Points

```{r}
d <- seq(from = 0, to = 1, by = 0.1)
power.table <- matrix(nrow = length(d), ncol = 10)
colnames(power.table) <- c("delta", "disapp", "reapp", "quant", 
                           "bray_qual", "bray_quant", "bray_omni", 
                           "adhoc_bray_qual", "adhoc_bray_quant", "quantMeanL2")

alpha <- 0.05
for (i in 1:length(d)) {
  disapp.tests <- as.matrix(read.table(paste("testresults/qual_disapp_d", d[i], "_s1_int30.txt", sep = ""), header = TRUE, colClasses = c("numeric")))
  reapp.tests <- as.matrix(read.table(paste("testresults/qual_reapp_d", d[i], "_s1_int30.txt", sep = ""), header = TRUE, colClasses = c("numeric")))
  quant.tests <- as.matrix(read.table(paste("testresults/quant_d", d[i], "_s1_int30.txt", sep = ""), header = TRUE, colClasses = c("numeric")))
  pldist.tests <- as.matrix(read.table(paste("testresults/pldist_bray_d", d[i], "_s1_int30.txt", sep = ""), header = TRUE, colClasses = c("numeric")))
  adhoc.qual <- as.matrix(read.table(paste("testresults/adhoc_bray_qual_d", d[i], "_s1_int30.txt", sep = ""), header = TRUE, colClasses = c("numeric")))
  adhoc.quant <- as.matrix(read.table(paste("testresults/adhoc_bray_quant_d", d[i], "_s1_int30.txt", sep = ""), header = TRUE, colClasses = c("numeric")))
  quant.meanL2 <- as.matrix(read.table(paste("testresults/quant_d", d[i], "_s1_int30_meanL2.txt", sep = ""), header = TRUE, colClasses = c("numeric")))
  
  disapp.pvals <- disapp.tests[ , ncol(disapp.tests)]
  reapp.pvals <- reapp.tests[ ,ncol(reapp.tests)]
  quant.pvals <- quant.tests[ ,ncol(quant.tests)]
  adhoc.qual.pvals <- adhoc.qual[ ,ncol(adhoc.qual)]
  adhoc.quant.pvals <- adhoc.quant[ ,ncol(adhoc.quant)]
  quant.meanL2.pvals <- quant.meanL2[ ,ncol(quant.meanL2)]
  
  power.table[i,1] <- d[i] # difference in mean of subject random intercept distribution between groups
  power.table[i,2] <- mean(disapp.pvals < alpha, na.rm = TRUE) # power
  power.table[i,3] <- mean(reapp.pvals < alpha, na.rm = TRUE)
  power.table[i,4] <- mean(quant.pvals < alpha, na.rm = TRUE)
  power.table[i,5:7] <- apply(pldist.tests, 2, function(x) mean(x < alpha, na.rm = TRUE))
  power.table[i,8] <- mean(adhoc.qual.pvals < alpha, na.rm = TRUE)
  power.table[i,9] <- mean(adhoc.quant.pvals < alpha, na.rm = TRUE)
  power.table[i,10] <- mean(quant.meanL2.pvals < alpha, na.rm = TRUE)
  
  # print(paste("For delta = ", d[i], ", ", length(pvals), " tests were returned.", sep = ""))
  # hist(pvals, breaks = seq(from = 0, to = 1, by = 0.05), xlim = c(0,1), 
  #      main = bquote("Histogram of p-values for " ~ delta == .(d[i])))
}

```

```{r}
plot(x = power.table[ ,1], y = power.table[ ,2], ylim = c(0,1), type = "o", pch = 15, lty = 1, col = "red",
     main = "Qualitative Difference Only Scenarios", sub = "Balanced Subsampling: 4 Intervals of 30 time points",
     xlab = expression("Effect Size" ~ delta), ylab = "Power")

points(x = power.table[ ,1], y = power.table[ ,3], pch = 16, col = "red")
lines(x = power.table[ ,1], y = power.table[ ,3], lty = 2, col = "red")
points(x = power.table[ ,1], y = power.table[ ,4], pch = 17, col = "red")
lines(x = power.table[ ,1], y = power.table[ ,4], lty = 3, col = "red")
points(x = power.table[ ,1], y = power.table[ ,5], pch = 1)
lines(x = power.table[ ,1], y = power.table[ ,5], lty = 4)
points(x = power.table[ ,1], y = power.table[ ,6], pch = 2)
lines(x = power.table[ ,1], y = power.table[ ,6], lty = 5)
points(x = power.table[ ,1], y = power.table[ ,7], pch = 5)
lines(x = power.table[ ,1], y = power.table[ ,7], lty = 6)
points(x = power.table[ ,1], y = power.table[ ,8], pch = 3)
lines(x = power.table[ ,1], y = power.table[ ,8], lty = 7)
points(x = power.table[ ,1], y = power.table[ ,9], pch = 4)
lines(x = power.table[ ,1], y = power.table[ ,9], lty = 8)
points(x = power.table[ ,1], y = power.table[ ,10], pch = 18, col = "red")
lines(x = power.table[ ,1], y = power.table[ ,10], lty = 9, col = "red")

legend(0, 1, legend=c("Disapp", "Reapp","Quant", 
                      expression(K[BB]), expression(K[BQ]), expression(K[omni]),
                      expression(adhoc[BB]), expression(adhoc[BQ]), bquote("Quant"["Mean L2"])),
       pch=c(15, 16, 17, 1, 2, 5, 3, 4, 18), lty=1:(ncol(power.table)-1), 
       col=c(rep("red", 3), rep("black", (ncol(power.table)-5)), "red"), 
       ncol=1)

power.table
```

# Only Quantitative Difference Scenarios

```{r}
f <- seq(from = 1, to = 1.5, by = 0.05)
power.table <- matrix(nrow = length(f), ncol = 10)
colnames(power.table) <- c("f", "disapp", "reapp", "quant", 
                           "bray_qual", "bray_quant", "bray_omni", 
                           "adhoc_bray_qual", "adhoc_bray_quant", "quant_meanL2")

alpha <- 0.05
for (i in 1:length(f)) {
  disapp.tests <- as.matrix(read.table(paste("testresults/qual_disapp_b1_f", f[i], ".txt", sep = ""), header = TRUE, colClasses = c("numeric")))
  reapp.tests <- as.matrix(read.table(paste("testresults/qual_reapp_b1_f", f[i], ".txt", sep = ""), header = TRUE, colClasses = c("numeric")))
  quant.tests <- as.matrix(read.table(paste("testresults/quant_b1_f", f[i], ".txt", sep = ""), header = TRUE, colClasses = c("numeric")))
  pldist.tests <- as.matrix(read.table(paste("testresults/pldist_bray_b1_f", f[i], ".txt", sep = ""), header = TRUE, colClasses = c("numeric")))
  adhoc.qual <- as.matrix(read.table(paste("testresults/adhoc_bray_qual_b1_f", f[i], ".txt", sep = ""), header = TRUE, colClasses = c("numeric")))
  adhoc.quant <- as.matrix(read.table(paste("testresults/adhoc_bray_quant_b1_f", f[i], ".txt", sep = ""), header = TRUE, colClasses = c("numeric")))
  quant.meanL2 <- as.matrix(read.table(paste("testresults/quant_b1_f", f[i], "_int1_meanL2.txt", sep = ""), header = TRUE, colClasses = c("numeric")))

  disapp.pvals <- disapp.tests[ , ncol(disapp.tests)]
  reapp.pvals <- reapp.tests[ , ncol(reapp.tests)]
  quant.pvals <- quant.tests[ , ncol(quant.tests)]
  adhoc.qual.pvals <- adhoc.qual[ , ncol(adhoc.qual)]
  adhoc.quant.pvals <- adhoc.quant[ , ncol(adhoc.quant)]
  quant.meanL2.pvals <- quant.meanL2[ ,ncol(quant.meanL2)]

  power.table[i,1] <- f[i] # multiplicative difference in variance of log fold-changes between groups
  power.table[i,2] <- mean(disapp.pvals < alpha, na.rm = TRUE) # power
  power.table[i,3] <- mean(reapp.pvals < alpha, na.rm = TRUE)
  power.table[i,4] <- mean(quant.pvals < alpha, na.rm = TRUE)
  power.table[i,5:7] <- apply(pldist.tests, 2, function(x) mean(x < alpha, na.rm = TRUE))
  power.table[i,8] <- mean(adhoc.qual.pvals < alpha, na.rm = TRUE)
  power.table[i,9] <- mean(adhoc.quant.pvals < alpha, na.rm = TRUE)
  power.table[i,10] <- mean(quant.meanL2.pvals < alpha, na.rm = TRUE)
}
```

```{r}
par(mar = c(5, 4, 4, 8), xpd = TRUE)

plot(x = power.table[ ,1], y = power.table[ ,2], ylim = c(0,1), type = "o", pch = 15, lty = 1, col = "red",
     main = "Quantitative Difference Only Scenarios", xlab = bquote("Effect Size" ~ sigma[2]^2 == delta * sigma[1]^2), ylab = "Power")

points(x = power.table[ ,1], y = power.table[ ,3], pch = 16, col = "red")
lines(x = power.table[ ,1], y = power.table[ ,3], lty = 2, col = "red")
points(x = power.table[ ,1], y = power.table[ ,4], pch = 17, col = "red")
lines(x = power.table[ ,1], y = power.table[ ,4], lty = 3, col = "red")
points(x = power.table[ ,1], y = power.table[ ,5], pch = 1)
lines(x = power.table[ ,1], y = power.table[ ,5], lty = 4)
points(x = power.table[ ,1], y = power.table[ ,6], pch = 2)
lines(x = power.table[ ,1], y = power.table[ ,6], lty = 5)
points(x = power.table[ ,1], y = power.table[ ,7], pch = 5)
lines(x = power.table[ ,1], y = power.table[ ,7], lty = 6)
points(x = power.table[ ,1], y = power.table[ ,8], pch = 3)
lines(x = power.table[ ,1], y = power.table[ ,8], lty = 7)
points(x = power.table[ ,1], y = power.table[ ,9], pch = 4)
lines(x = power.table[ ,1], y = power.table[ ,9], lty = 8)
points(x = power.table[ ,1], y = power.table[ ,10], pch = 18, col = "red")
lines(x = power.table[ ,1], y = power.table[ ,10], lty = 9, col = "red")

legend("topright", inset = c(-0.32, 0), 
       legend=c("Disapp", "Reapp","Quant", 
                expression(K[BB]), expression(K[BQ]), expression(K[omni]),
                expression(adhoc[BB]), expression(adhoc[BQ]), bquote("Quant"["Mean L2"])),
       pch=c(15, 16, 17, 1, 2, 5, 3, 4, 18), lty=1:(ncol(power.table)-1), 
       col=c(rep("red", 3), rep("black", (ncol(power.table)-5)), "red"), 
       ncol=1)

power.table
```

## Balanced Subsampled: 4 Intervals of 30 Time Points

```{r}
f <- seq(from = 1, to = 1.5, by = 0.05)
power.table <- matrix(nrow = length(f), ncol = 10)
colnames(power.table) <- c("f", "disapp", "reapp", "quant", 
                           "bray_qual", "bray_quant", "bray_omni", 
                           "adhoc_bray_qual", "adhoc_bray_quant", "quant_meanL2")

alpha <- 0.05
for (i in 1:length(f)) {
  disapp.tests <- as.matrix(read.table(paste("testresults/qual_disapp_b1_f", f[i], "_int30.txt", sep = ""), header = TRUE, colClasses = c("numeric")))
  reapp.tests <- as.matrix(read.table(paste("testresults/qual_reapp_b1_f", f[i], "_int30.txt", sep = ""), header = TRUE, colClasses = c("numeric")))
  quant.tests <- as.matrix(read.table(paste("testresults/quant_b1_f", f[i], "_int30.txt", sep = ""), header = TRUE, colClasses = c("numeric")))
  pldist.tests <- as.matrix(read.table(paste("testresults/pldist_bray_b1_f", f[i], "_int30.txt", sep = ""), header = TRUE, colClasses = c("numeric")))
  adhoc.qual <- as.matrix(read.table(paste("testresults/adhoc_bray_qual_b1_f", f[i], "_int30.txt", sep = ""), header = TRUE, colClasses = c("numeric")))
  adhoc.quant <- as.matrix(read.table(paste("testresults/adhoc_bray_quant_b1_f", f[i], "_int30.txt", sep = ""), header = TRUE, colClasses = c("numeric")))
  quant.meanL2 <- as.matrix(read.table(paste("testresults/quant_b1_f", f[i], "_int30_meanL2.txt", sep = ""), header = TRUE, colClasses = c("numeric")))

  disapp.pvals <- disapp.tests[ , ncol(disapp.tests)]
  reapp.pvals <- reapp.tests[ , ncol(reapp.tests)]
  quant.pvals <- quant.tests[ , ncol(quant.tests)]
  adhoc.qual.pvals <- adhoc.qual[ , ncol(adhoc.qual)]
  adhoc.quant.pvals <- adhoc.quant[ , ncol(adhoc.quant)]
  quant.meanL2.pvals <- quant.meanL2[ , ncol(quant.meanL2)]

  power.table[i,1] <- f[i] # multiplicative difference in variance of log fold-changes between groups
  power.table[i,2] <- mean(disapp.pvals < alpha, na.rm = TRUE) # power
  power.table[i,3] <- mean(reapp.pvals < alpha, na.rm = TRUE)
  power.table[i,4] <- mean(quant.pvals < alpha, na.rm = TRUE)
  power.table[i,5:7] <- apply(pldist.tests, 2, function(x) mean(x < alpha, na.rm = TRUE))
  power.table[i,8] <- mean(adhoc.qual.pvals < alpha, na.rm = TRUE)
  power.table[i,9] <- mean(adhoc.quant.pvals < alpha, na.rm = TRUE)
  power.table[i,10] <- mean(quant.meanL2.pvals < alpha, na.rm = TRUE)
}
```

```{r}
plot(x = power.table[ ,1], y = power.table[ ,2], ylim = c(0,1), type = "o", pch = 15, lty = 1, col = "red",
     main = "Quantitative Difference Only Scenarios", sub = "Balanced Subsampling: 4 Intervals of 30 time points",
     xlab = bquote("Effect Size" ~ sigma[2]^2 == delta * sigma[1]^2), ylab = "Power")

points(x = power.table[ ,1], y = power.table[ ,3], pch = 16, col = "red")
lines(x = power.table[ ,1], y = power.table[ ,3], lty = 2, col = "red")
points(x = power.table[ ,1], y = power.table[ ,4], pch = 17, col = "red")
lines(x = power.table[ ,1], y = power.table[ ,4], lty = 3, col = "red")
points(x = power.table[ ,1], y = power.table[ ,5], pch = 1)
lines(x = power.table[ ,1], y = power.table[ ,5], lty = 4)
points(x = power.table[ ,1], y = power.table[ ,6], pch = 2)
lines(x = power.table[ ,1], y = power.table[ ,6], lty = 5)
points(x = power.table[ ,1], y = power.table[ ,7], pch = 5)
lines(x = power.table[ ,1], y = power.table[ ,7], lty = 6)
points(x = power.table[ ,1], y = power.table[ ,8], pch = 3)
lines(x = power.table[ ,1], y = power.table[ ,8], lty = 7)
points(x = power.table[ ,1], y = power.table[ ,9], pch = 4)
lines(x = power.table[ ,1], y = power.table[ ,9], lty = 8)
points(x = power.table[ ,1], y = power.table[ ,10], pch = 18, col = "red")
lines(x = power.table[ ,1], y = power.table[ ,10], lty = 9, col = "red")

legend(1, 1, legend=c("Disapp", "Reapp","Quant", 
                      expression(K[BB]), expression(K[BQ]), expression(K[omni]),
                      expression(adhoc[BB]), expression(adhoc[BQ]), bquote("Quant"["Mean L2"])),
       pch=c(15, 16, 17, 1, 2, 5, 3, 4, 18), lty=1:(ncol(power.table)-1), 
       col=c(rep("red", 3), rep("black", (ncol(power.table)-5)), "red"), 
       ncol=1)

power.table
```

# Dethlefsen and Relman: 
- three individuals (D, E, F)
- 52 to 56 stool samples per subject
- over 10 months
- two 5-day courses (external perturbations) of the antibiotic "ciprofloxacin" (Cp) separated by 6 months
- samples were collected daily for two 19-day periods surrounding each Cp course and weekly or monthly at other times

Taxa are rows; Samples are columns
```{r}
dethlefsen.relman.df <- read.delim(file = "/Users/danieljbpark/Downloads/dethlefsen_relman_ds_01.txt")
```

We don't have metadata in a file format!!! 

```{r}
colnames(dethlefsen.relman.df); dim(dethlefsen.relman.df)
```

```{r}
dr.D.df <- dethlefsen.relman.df %>%
  dplyr::select(matches("D\\d", ignore.case = FALSE))

dr.E.df <- dethlefsen.relman.df %>%
  dplyr::select(matches("E\\d", ignore.case = FALSE))

dr.F.df <- dethlefsen.relman.df %>%
  dplyr::select(matches("F\\d", ignore.case = FALSE))

dim(dr.D.df); dim(dr.E.df); dim(dr.F.df)
```

```{r}
dr.D.otutab <- phyloseq(otu_table(dr.D.df, taxa_are_rows = TRUE))
dr.D.rel.otutab <- transform(dr.D.otutab, transform = "compositional", target = 'OTU')

dr.E.otutab <- phyloseq(otu_table(dr.E.df, taxa_are_rows = TRUE))
dr.E.rel.otutab <- transform(dr.E.otutab, transform = "compositional", target = 'OTU')

dr.F.otutab <- phyloseq(otu_table(dr.F.df, taxa_are_rows = TRUE))
dr.F.rel.otutab <- transform(dr.F.otutab, transform = "compositional", target = 'OTU')

# relative abundances for each sample sum to 1
all(colSums(dr.D.rel.otutab) == 1); all(colSums(dr.E.rel.otutab) == 1); all(colSums(dr.F.rel.otutab) == 1)
```

```{r}
# select OTUs that appear at least once across samples
n.threshold <- 0
dr.D.otutab <- dr.D.otutab[apply(dr.D.otutab, 1, sum) > n.threshold, ]
dr.E.otutab <- dr.E.otutab[apply(dr.E.otutab, 1, sum) > n.threshold, ]
dr.F.otutab <- dr.F.otutab[apply(dr.F.otutab, 1, sum) > n.threshold, ]

dr.D.rel.otutab <- dr.D.rel.otutab[apply(dr.D.rel.otutab, 1, sum) > n.threshold, ]
dr.E.rel.otutab <- dr.E.rel.otutab[apply(dr.E.rel.otutab, 1, sum) > n.threshold, ]
dr.F.rel.otutab <- dr.F.rel.otutab[apply(dr.F.rel.otutab, 1, sum) > n.threshold, ]

dim(dr.D.otutab); dim(dr.E.otutab); dim(dr.F.otutab)

# clr-transformed abundances for OTUs that are non-trivial
dr.D.clr.otutab <- transform(dr.D.otutab, transform = "clr")
dr.E.clr.otutab <- transform(dr.E.otutab, transform = "clr")
dr.F.clr.otutab <- transform(dr.F.otutab, transform = "clr")

# median clr-transformed abundance by OTU
dr.D.med.clr <- apply(dr.D.clr.otutab, 1, median)
dr.E.med.clr <- apply(dr.E.clr.otutab, 1, median)
dr.F.med.clr <- apply(dr.F.clr.otutab, 1, median)
```

```{r}
# f4.metadata # 130 rows, 3 cols
# otutab
# rel.otutab
# clr.otutab
# med.clr

# sample.depth
dr.D.sample.depth <- colSums(dr.D.otutab)
dr.E.sample.depth <- colSums(dr.E.otutab)
dr.F.sample.depth <- colSums(dr.F.otutab)

save(dr.D.otutab, dr.D.rel.otutab, dr.D.clr.otutab, 
     dr.D.med.clr, dr.D.sample.depth,
     dr.E.otutab, dr.E.rel.otutab, dr.E.clr.otutab, 
     dr.E.med.clr, dr.E.sample.depth,
     dr.F.otutab, dr.F.rel.otutab, dr.F.clr.otutab, 
     dr.F.med.clr, dr.F.sample.depth,
     file = "dethlefsen_relman.Rdata")
```

```{r}
sum(rowSums(dr.D.otutab) == 0)
sum(dr.D.med.clr == 0)
```

## Metadata
```{r}
library(lubridate)
library(readr)
dr.metadata <- read_csv("/Users/danieljbpark/Downloads/dethlefsen-relman-metadata.csv") %>%
  dplyr::select(treatment:subjID) %>%
  mutate(date = mdy(date))

# this gets us the difference in days between consecutive samples.
time.diff <- as.duration(int_diff(dr.metadata$date)) / ddays(1)

head(dr.metadata)
dim(dr.metadata)
length(time.diff)
time.diff

```


