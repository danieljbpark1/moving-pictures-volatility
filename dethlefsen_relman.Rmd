---
title: "Dethlefsen and Relman Microbiome Dataset"
author: "Daniel J. Park"
date: "10/25/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dplyr)
library(phyloseq)
library(microbiome)
```

Dethlefsen and Relman: 
- three individuals (D, E, F)
- 52 to 56 stool samples per subject
- over 10 months
- two 5-day courses (external perturbations) of the antibiotic "ciprofloxacin" (Cp) separated by 6 months
- samples were collected daily for two 19-day periods surrounding each Cp course and weekly or monthly at other times

Taxa are rows; Samples are columns
```{r}
dethlefsen.relman.df <- read.delim(file = "/Users/danieljbpark/Downloads/dethlefsen_relman_ds_01.txt")
```

We don't have metadata in a file format!!! 

```{r}
colnames(dethlefsen.relman.df); dim(dethlefsen.relman.df)
```

```{r}
dr.D.df <- dethlefsen.relman.df %>%
  dplyr::select(matches("D\\d", ignore.case = FALSE))

dr.E.df <- dethlefsen.relman.df %>%
  dplyr::select(matches("E\\d", ignore.case = FALSE))

dr.F.df <- dethlefsen.relman.df %>%
  dplyr::select(matches("F\\d", ignore.case = FALSE))

dim(dr.D.df); dim(dr.E.df); dim(dr.F.df)
```

```{r}
dr.D.otutab <- phyloseq(otu_table(dr.D.df, taxa_are_rows = TRUE))
dr.D.rel.otutab <- transform(dr.D.otutab, transform = "compositional", target = 'OTU')

dr.E.otutab <- phyloseq(otu_table(dr.E.df, taxa_are_rows = TRUE))
dr.E.rel.otutab <- transform(dr.E.otutab, transform = "compositional", target = 'OTU')

dr.F.otutab <- phyloseq(otu_table(dr.F.df, taxa_are_rows = TRUE))
dr.F.rel.otutab <- transform(dr.F.otutab, transform = "compositional", target = 'OTU')

# relative abundances for each sample sum to 1
all(colSums(dr.D.rel.otutab) == 1); all(colSums(dr.E.rel.otutab) == 1); all(colSums(dr.F.rel.otutab) == 1)
```

```{r}
# select OTUs that appear at least once across samples
n.threshold <- 0
dr.D.otutab <- dr.D.otutab[apply(dr.D.otutab, 1, sum) > n.threshold, ]
dr.E.otutab <- dr.E.otutab[apply(dr.E.otutab, 1, sum) > n.threshold, ]
dr.F.otutab <- dr.F.otutab[apply(dr.F.otutab, 1, sum) > n.threshold, ]

dr.D.rel.otutab <- dr.D.rel.otutab[apply(dr.D.rel.otutab, 1, sum) > n.threshold, ]
dr.E.rel.otutab <- dr.E.rel.otutab[apply(dr.E.rel.otutab, 1, sum) > n.threshold, ]
dr.F.rel.otutab <- dr.F.rel.otutab[apply(dr.F.rel.otutab, 1, sum) > n.threshold, ]

dim(dr.D.otutab); dim(dr.E.otutab); dim(dr.F.otutab)

# clr-transformed abundances for OTUs that are non-trivial
dr.D.clr.otutab <- transform(dr.D.otutab, transform = "clr")
dr.E.clr.otutab <- transform(dr.E.otutab, transform = "clr")
dr.F.clr.otutab <- transform(dr.F.otutab, transform = "clr")

# median clr-transformed abundance by OTU
dr.D.med.clr <- apply(dr.D.clr.otutab, 1, median)
dr.E.med.clr <- apply(dr.E.clr.otutab, 1, median)
dr.F.med.clr <- apply(dr.F.clr.otutab, 1, median)
```

```{r}
# f4.metadata # 130 rows, 3 cols
# otutab
# rel.otutab
# clr.otutab
# med.clr

# sample.depth
dr.D.sample.depth <- colSums(dr.D.otutab)
dr.E.sample.depth <- colSums(dr.E.otutab)
dr.F.sample.depth <- colSums(dr.F.otutab)

save(dr.D.otutab, dr.D.rel.otutab, dr.D.clr.otutab, 
     dr.D.med.clr, dr.D.sample.depth,
     dr.E.otutab, dr.E.rel.otutab, dr.E.clr.otutab, 
     dr.E.med.clr, dr.E.sample.depth,
     dr.F.otutab, dr.F.rel.otutab, dr.F.clr.otutab, 
     dr.F.med.clr, dr.F.sample.depth,
     file = "dethlefsen_relman.Rdata")
```

```{r}
sum(rowSums(dr.D.otutab) == 0)
sum(dr.D.med.clr == 0)
```

## Metadata
```{r}
library(lubridate)
library(readr)
dr.metadata <- read_csv("/Users/danieljbpark/Downloads/dethlefsen-relman-metadata.csv") %>%
  dplyr::select(treatment:subjID) %>%
  mutate(date = mdy(date))

# this gets us the difference in days between consecutive samples.
time.diff <- as.duration(int_diff(dr.metadata$date)) / ddays(1)

head(dr.metadata)
dim(dr.metadata)
length(time.diff)
time.diff

```


