---
title: "Moving Pictures Probability of Reappearance"
author: "Daniel J. Park"
date: "7/17/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(ggplot2)
library(dplyr)
library(zoib)
library(boot)
require(foreign)
require(MASS)
require(Hmisc)
source("../mp_analysis_functions.R")
```

```{r}
# f4.metadata : metadata sorted by time
# otu.counts.f4 : OTU counts
# otu.relabs.f4 : OTU relative abundances
# otu.clrabs.f4 : OTU clr-transformed abundances
# median.otu.relabs.f4 : OTU's median relative abundance across all samples
# median.otu.clrabs.f4 : OTU's median clr-transformed abundance across all samples
# coverage.f4 : the total number of reads by sample
load("../mp_F4_data.Rdata")
load("../mp_M3_data.Rdata")
```

# Probability of reappearance

```{r}
# a vector of probabilities of reappearing from absence by OTU
prob.reappear.f4 <- reappearance_probabilities(otu.relabs.f4)
prob.reappear.m3 <- reappearance_probabilities(otu.relabs.m3)

# bind in a dataframe with OTUs' median clr-transformed abundance across all samples
reappear.df.f4 <- data.frame(prob.reappear = prob.reappear.f4, 
                             median.clr = median.otu.clrabs.f4)
reappear.df.m3 <- data.frame(prob.reappear = prob.reappear.m3,
                             median.clr = median.otu.clrabs.m3)

reappear.df.f4 <- subset(reappear.df.f4, is.finite(prob.reappear))
reappear.df.m3 <- subset(reappear.df.m3, is.finite(prob.reappear))

reapp.plot.f4 <- ggplot(reappear.df.f4, aes(x = median.clr, y = prob.reappear)) +
  geom_point(color="seagreen") + 
  labs(y = "probability of reappearance", x = "median clr-transformed abundance", title = "OTUs for subject F4")
reapp.plot.m3 <- ggplot(reappear.df.m3, aes(x = median.clr, y = prob.reappear)) +
  geom_point(color="purple") + 
  labs(y = "probability of reappearance", x = "median clr-transformed abundance", title = "OTUs for subject M3")

reapp.plot.f4
reapp.plot.m3
```

# One-inflated Beta Regression
Model the probability of reappearance as a one-inflated beta regression. The mean and dispersion parameters of the beta distribution and  the probability of one-inflation depend on the median clr-transformed abundance.

```{r}
oibr.reapp.f4 <- zoib(prob.reappear ~ median.clr | median.clr | median.clr, data = reappear.df.f4, 
                      joint = FALSE, zero.inflation = FALSE, one.inflation = TRUE, 
                      EUID = rownames(reappear.df.f4), n.iter = 2000)

oibr.reapp.m3 <- zoib(prob.reappear ~ median.clr | median.clr | median.clr, data = reappear.df.m3, 
                      joint = FALSE, zero.inflation = FALSE, one.inflation = TRUE, 
                      EUID = rownames(reappear.df.f4), n.iter = 2000)

save(oibr.reapp.f4, file = "oibr_reapp_f4.Rdata")
save(oibr.reapp.m3, file = "oibr_reapp_m3.Rdata")

```

The potential scale reduction factors from the Gelman plots for both subjects suggest good MCMC convergence. 

```{r}
#load("oibr_reapp_f4.Rdata")
#load("oibr_reapp_m3.Rdata")

traceplot(oibr.reapp.f4$coeff) ; autocorr.plot(oibr.reapp.f4$coeff) ; gelman.diag(oibr.reapp.f4$coeff)
traceplot(oibr.reapp.m3$coeff) ; autocorr.plot(oibr.reapp.m3$coeff) ; gelman.diag(oibr.reapp.m3$coeff)
```

## Simulating probability of colonization by OTU
Coefficients are presented in the order of b, b0, b1, d, where b is for the beta mean, b0 and b1 are for the 0 and 1 inflation, and d is for the beta dispersion.

```{r}
oibr.reapp.coefs.f4 <- summary(oibr.reapp.f4$coeff)
oibr.reapp.coefs.m3 <- summary(oibr.reapp.m3$coeff)

reappear.df.f4$oibr.pred <- sim.zoib(oibr.reapp.f4, 
                                     beta.mean.coefs = oibr.reapp.coefs.f4$statistics[1:2, 1],
                                     infl.coefs = oibr.reapp.coefs.f4$statistics[3:4, 1],
                                     beta.disp.coefs = oibr.reapp.coefs.f4$statistics[5:6, 1],
                                     infl = 1)
reappear.df.m3$oibr.pred <- sim.zoib(oibr.reapp.m3,
                                     beta.mean.coefs = oibr.reapp.coefs.m3$statistics[1:2, 1],
                                     infl.coefs = oibr.reapp.coefs.m3$statistics[3:4, 1],
                                     beta.disp.coefs = oibr.reapp.coefs.m3$statistics[5:6, 1],
                                     infl = 1)
```

## Plot of simulated probability of colonization by OTU

```{r}
require(gridExtra)

sim.reapp.f4 <- ggplot(reappear.df.f4, aes(x = median.clr, y = oibr.pred)) +
  geom_point(color="sienna") + 
  labs(y = "OIBR simulated probability of reappearance", x = "median clr-transformed abundance", title = "OTUs for subject F4")
sim.reapp.m3 <- ggplot(reappear.df.m3, aes(x = median.clr, y = oibr.pred)) +
  geom_point(color="turquoise") + 
  labs(y = "OIBR simulated probability of reappearance", x = "median clr-transformed abundance", title = "OTUs for subject M3")

grid.arrange(reapp.plot.f4, sim.reapp.f4, nrow = 1)
grid.arrange(reapp.plot.m3, sim.reapp.m3, nrow = 1)

```

